name: 'Generate Terraform Variables'
description: 'Generate terraform.tfvars file based on environment and mode'
inputs:
  environment:
    description: 'Environment name'
    required: true
  mode:
    description: 'Mode: deploy, cleanup, or teardown'
    required: true
    default: 'deploy'

runs:
  using: 'composite'
  steps:
    - name: Retrieve app configuration
      id: app-config
      shell: bash
      run: |
        if [ "${{ inputs.mode }}" = "deploy" ]; then
          echo "ðŸ” Looking up app configuration for environment: ${{ inputs.environment }}"
          
          # Use a simple script to extract app config (similar to get-env-config.sh)
          cat > get-app-config.sh << 'EOF'
          #!/bin/bash
          ENV_NAME="$1"
          CONFIG_FILE=".github/app-config.json"
          
          if [[ ! -f "$CONFIG_FILE" ]]; then
            echo "Warning: app-config.json not found, using defaults" >&2
            echo "debug=true"
            echo "current_port=8000"
            echo "enable_emails=false"
            echo "use_aws_storage=false"
            exit 0
          fi
          
          # Try exact match first
          CONFIG=$(jq -r --arg env "$ENV_NAME" '.environments[$env] // empty' "$CONFIG_FILE")
          
          # Try pattern match
          if [[ -z "$CONFIG" || "$CONFIG" == "null" ]]; then
            if [[ "$ENV_NAME" =~ ^pr-[0-9]+$ ]]; then
              CONFIG=$(jq -r '.patterns["pr-*"] // empty' "$CONFIG_FILE")
            elif [[ "$ENV_NAME" == "main" ]]; then
              CONFIG=$(jq -r '.patterns["main"] // empty' "$CONFIG_FILE")
            fi
          fi
          
          # Use defaults if still not found
          if [[ -z "$CONFIG" || "$CONFIG" == "null" ]]; then
            CONFIG=$(jq -r '.defaults' "$CONFIG_FILE")
          fi
          
          # Extract values
          echo "debug=$(echo "$CONFIG" | jq -r '.django.debug // true')"
          echo "current_port=$(echo "$CONFIG" | jq -r '.django.current_port // 8000')"
          echo "allowed_hosts=$(echo "$CONFIG" | jq -r '.django.allowed_hosts // "server,localhost,127.0.0.1"')"
          echo "enable_emails=$(echo "$CONFIG" | jq -r '.django.enable_emails // false')"
          echo "staff_email=$(echo "$CONFIG" | jq -r '.django.staff_email // "admin@example.com"')"
          echo "use_aws_storage=$(echo "$CONFIG" | jq -r '.aws.use_aws_storage // false')"
          echo "aws_s3_region_name=$(echo "$CONFIG" | jq -r '.aws.aws_s3_region_name // ""')"
          echo "enable_https=$(echo "$CONFIG" | jq -r '.features.enable_https // true')"
          echo "playwright_test_base_url=$(echo "$CONFIG" | jq -r '.testing.playwright_test_base_url // "http://localhost:8000"')"
          echo "secrets_set=$(echo "$CONFIG" | jq -r '.secrets_set // "DEV_SECRETS"')"
          EOF
          
          chmod +x get-app-config.sh
          APP_CONFIG_OUTPUT=$(./get-app-config.sh "${{ inputs.environment }}")
          
          # Set outputs
          echo "debug=$(echo "$APP_CONFIG_OUTPUT" | grep "^debug=" | cut -d= -f2)" >> $GITHUB_OUTPUT
          echo "current_port=$(echo "$APP_CONFIG_OUTPUT" | grep "^current_port=" | cut -d= -f2)" >> $GITHUB_OUTPUT
          echo "allowed_hosts=$(echo "$APP_CONFIG_OUTPUT" | grep "^allowed_hosts=" | cut -d= -f2)" >> $GITHUB_OUTPUT
          echo "enable_emails=$(echo "$APP_CONFIG_OUTPUT" | grep "^enable_emails=" | cut -d= -f2)" >> $GITHUB_OUTPUT
          echo "staff_email=$(echo "$APP_CONFIG_OUTPUT" | grep "^staff_email=" | cut -d= -f2)" >> $GITHUB_OUTPUT
          echo "use_aws_storage=$(echo "$APP_CONFIG_OUTPUT" | grep "^use_aws_storage=" | cut -d= -f2)" >> $GITHUB_OUTPUT
          echo "aws_s3_region_name=$(echo "$APP_CONFIG_OUTPUT" | grep "^aws_s3_region_name=" | cut -d= -f2)" >> $GITHUB_OUTPUT
          echo "enable_https=$(echo "$APP_CONFIG_OUTPUT" | grep "^enable_https=" | cut -d= -f2)" >> $GITHUB_OUTPUT
          
          echo "âœ… App configuration loaded for environment '${{ inputs.environment }}'"
          rm -f get-app-config.sh
        else
          # For cleanup/teardown, use default values
          echo "debug=false" >> $GITHUB_OUTPUT
          echo "current_port=8000" >> $GITHUB_OUTPUT
          echo "allowed_hosts=localhost" >> $GITHUB_OUTPUT
          echo "enable_emails=false" >> $GITHUB_OUTPUT
          echo "staff_email=admin@example.com" >> $GITHUB_OUTPUT
          echo "use_aws_storage=false" >> $GITHUB_OUTPUT
          echo "aws_s3_region_name=" >> $GITHUB_OUTPUT
          echo "enable_https=true" >> $GITHUB_OUTPUT
        fi

    - name: Retrieve secrets from S3
      id: secrets
      shell: bash
      run: |
        if [ "${{ inputs.mode }}" = "deploy" ]; then
          ENVIRONMENT="${{ inputs.environment }}"
          
          echo "ðŸ” Retrieving secrets for environment: $ENVIRONMENT"
          
          # Use our secrets-sync script which has fallback logic for PRs
          if .github/scripts/secrets-sync.sh pull "$ENVIRONMENT" --file secrets.json; then
            echo "âœ… Successfully retrieved secrets"
            
            # Validate JSON
            if ! jq empty secrets.json 2>/dev/null; then
              echo "âŒ Retrieved file contains invalid JSON"
              exit 1
            fi
            
            # Extract secrets to masked GitHub Actions outputs
            echo "django_secret_key=$(jq -r '.secrets.django_secret_key' secrets.json)" >> $GITHUB_OUTPUT
            echo "db_password=$(jq -r '.secrets.db_password' secrets.json)" >> $GITHUB_OUTPUT
            echo "django_superuser_password=$(jq -r '.secrets.django_superuser_password' secrets.json)" >> $GITHUB_OUTPUT
            echo "rollbar_access_token=$(jq -r '.secrets.rollbar_access_token // ""' secrets.json)" >> $GITHUB_OUTPUT
            echo "aws_access_key_id=$(jq -r '.secrets.aws_access_key_id // ""' secrets.json)" >> $GITHUB_OUTPUT
            echo "aws_secret_access_key=$(jq -r '.secrets.aws_secret_access_key // ""' secrets.json)" >> $GITHUB_OUTPUT
            echo "playwright_test_user_pass=$(jq -r '.secrets.playwright_test_user_pass' secrets.json)" >> $GITHUB_OUTPUT
            
            echo "âœ… Secrets extracted and masked"
            rm -f secrets.json
          else
            echo "âŒ Failed to retrieve secrets"
            echo "ðŸ’¡ Check secrets configuration for environment: $ENVIRONMENT"
            exit 1
          fi
        else
          # For cleanup/teardown, use placeholder values
          echo "django_secret_key=${{ inputs.mode }}_placeholder" >> $GITHUB_OUTPUT
          echo "db_password=${{ inputs.mode }}_placeholder" >> $GITHUB_OUTPUT
          echo "django_superuser_password=${{ inputs.mode }}_placeholder" >> $GITHUB_OUTPUT
          echo "rollbar_access_token=" >> $GITHUB_OUTPUT
          echo "aws_access_key_id=" >> $GITHUB_OUTPUT
          echo "aws_secret_access_key=" >> $GITHUB_OUTPUT
          echo "playwright_test_user_pass=${{ inputs.mode }}_placeholder" >> $GITHUB_OUTPUT
        fi

    - name: Get environment configuration
      id: env-config
      shell: bash
      run: |
        ENV_CONFIG=$(.github/scripts/get-env-config.sh "${{ inputs.environment }}")
        
        # Extract values from config
        REGION=$(echo "$ENV_CONFIG" | grep "^region=" | cut -d= -f2)
        BASE_DOMAIN=$(echo "$ENV_CONFIG" | grep "^base_domain=" | cut -d= -f2)
        USE_CUSTOM_DOMAIN=$(echo "$ENV_CONFIG" | grep "^use_custom_domain=" | cut -d= -f2)
        CUSTOM_DOMAIN=$(echo "$ENV_CONFIG" | grep "^custom_domain=" | cut -d= -f2)
        ROUTE53_ZONE_ID=$(echo "$ENV_CONFIG" | grep "^route53_zone_id=" | cut -d= -f2)
        CERTIFICATE_ARN=$(echo "$ENV_CONFIG" | grep "^certificate_arn=" | cut -d= -f2)
        
        echo "aws_region=$REGION" >> $GITHUB_OUTPUT
        echo "base_domain=$BASE_DOMAIN" >> $GITHUB_OUTPUT
        echo "use_custom_domain=$USE_CUSTOM_DOMAIN" >> $GITHUB_OUTPUT
        echo "custom_domain=$CUSTOM_DOMAIN" >> $GITHUB_OUTPUT
        echo "route53_zone_id=$ROUTE53_ZONE_ID" >> $GITHUB_OUTPUT
        echo "certificate_arn=$CERTIFICATE_ARN" >> $GITHUB_OUTPUT

    - name: Generate terraform.tfvars
      shell: bash
      run: |
        cd terraform
        echo "ðŸ”§ Generating terraform.tfvars for ${{ inputs.mode }} of environment: ${{ inputs.environment }}"
        
        # Use GitHub Actions variables with terraform defaults as fallbacks
        SERVICE_NAME="${{ vars.SERVICE_NAME }}"
        ECR_REPOSITORY_NAME="${{ vars.ECR_REPOSITORY_NAME }}"
        
        # Create terraform.tfvars
        if [ -n "$SERVICE_NAME" ]; then
          echo "service = \"$SERVICE_NAME\"" >> terraform.tfvars
        fi
        
        if [ -n "$ECR_REPOSITORY_NAME" ]; then
          echo "ecr_app_repository_name = \"$ECR_REPOSITORY_NAME\"" >> terraform.tfvars
        fi
        
        # Set image tag based on mode
        if [ "${{ inputs.mode }}" = "deploy" ]; then
          IMAGE_TAG="${{ inputs.environment }}-${{ github.sha }}"
        else
          IMAGE_TAG="${{ inputs.mode }}"
        fi
        
        cat << EOF >> terraform.tfvars
        environment = "${{ inputs.environment }}"
        aws_region = "${{ steps.env-config.outputs.aws_region }}"
        ecr_tag = "$IMAGE_TAG"
        
        # Secrets
        secret_key = "${{ steps.secrets.outputs.django_secret_key }}"
        db_pass = "${{ steps.secrets.outputs.db_password }}"
        django_superuser_password = "${{ steps.secrets.outputs.django_superuser_password }}"
        rollbar_access_token = "${{ steps.secrets.outputs.rollbar_access_token }}"
        aws_access_key_id = "${{ steps.secrets.outputs.aws_access_key_id }}"
        aws_secret_access_key = "${{ steps.secrets.outputs.aws_secret_access_key }}"
        playwright_test_user_pass = "${{ steps.secrets.outputs.playwright_test_user_pass }}"
        
        # Database config
        db_name = "$(echo '{{cookiecutter.sanitized_tf_service_name}}${{ inputs.environment }}db' | tr -d '-')"
        db_user = "{{cookiecutter.sanitized_tf_service_name}}_${{ inputs.environment }}_user"
        
        # App configuration
        debug = "${{ steps.app-config.outputs.debug }}"
        current_port = "${{ steps.app-config.outputs.current_port }}"
        allowed_hosts = "${{ steps.app-config.outputs.allowed_hosts }}"
        enable_emails = "${{ steps.app-config.outputs.enable_emails }}"
        staff_email = "${{ steps.app-config.outputs.staff_email }}"
        use_aws_storage = "${{ steps.app-config.outputs.use_aws_storage }}"
        aws_s3_region_name = "${{ steps.app-config.outputs.aws_s3_region_name }}"
        enable_https = ${{ steps.app-config.outputs.enable_https }}
        
        # Placeholder for playwright URL - will be updated after deployment
        playwright_test_base_url = "http://localhost:8000"
        
        # Domain and Route53 configuration
        base_domain = "${{ steps.env-config.outputs.base_domain }}"
        use_custom_domain = ${{ steps.env-config.outputs.use_custom_domain }}
        current_domain = "${{ steps.env-config.outputs.custom_domain }}"
        route53_zone_id = "${{ steps.env-config.outputs.route53_zone_id }}"
        certificate_arn = "${{ steps.env-config.outputs.certificate_arn }}"
        
        # AWS profile (empty for CI/CD)
        aws_profile = ""
        EOF
        
        echo "âœ… Generated terraform.tfvars for ${{ inputs.mode }} with environment '${{ inputs.environment }}'"